<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Author</title>
  <style>
    :root{
      --bg:#0f1013; --panel:#171823; --panel2:#1e2030;
      --text:#f2f2f2; --muted:#a9abb7; --accent:#e11d48;
      --navh:64px; --toph:56px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:Arial,sans-serif;background:var(--bg);color:var(--text);
      padding-bottom:calc(var(--navh) + 12px);
    }
    a{color:inherit;text-decoration:none}

    .topbar{
      position:sticky;top:0;z-index:50;height:var(--toph);
      display:flex;align-items:center;gap:10px;padding:10px 12px;
      background:#0b0c10;border-bottom:1px solid #222;
    }
    .brand{font-weight:800;letter-spacing:.3px;white-space:nowrap;flex:0 0 auto;}
    .spacer{flex:1}
    .iconbtn{
      width:38px;height:38px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;
      background:var(--panel);border:1px solid #2a2b35;cursor:pointer;user-select:none;
      flex:0 0 auto;
    }

    .section{padding:12px;}
    @media (min-width:900px){
      body{padding-bottom:12px;}
      .bottomnav{display:none;}
      .section{max-width:1200px;margin:0 auto;}
      .topbar{max-width:1200px;margin:0 auto;}
    }

    .card{
      background:var(--panel);
      border:1px solid #2a2b35;
      border-radius:14px;
      padding:12px;
      margin-bottom:12px;
    }
    .headerRow{display:flex;align-items:center;gap:12px;}
    .avatar{
      width:52px;height:52px;border-radius:16px;
      background:var(--panel2);border:1px solid #2a2b35;
      display:flex;align-items:center;justify-content:center;
      font-weight:900;color:var(--muted);
      flex:0 0 auto;
    }
    .name{font-weight:900;font-size:16px;line-height:1.2;}
    .sub{color:var(--muted);font-size:12px;font-weight:700;margin-top:4px;}
    .pillRow{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap;}
    .pill{
      height:26px;padding:0 10px;border-radius:999px;
      background:var(--panel2);border:1px solid #2a2b35;
      color:var(--muted);font-size:12px;font-weight:900;
      display:inline-flex;align-items:center;gap:6px;
      white-space:nowrap;
    }
    .pill.plus{border-color:rgba(225,29,72,.65); color:var(--text);}

    .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;}
    @media(min-width:900px){ .grid{grid-template-columns:repeat(5, 1fr);} }

    .comic{
      background:var(--panel);border:1px solid #2a2b35;border-radius:14px;overflow:hidden;
      position:relative;
    }
    .cover{width:100%;height:190px;object-fit:cover;display:block;background:#333;}
    @media(min-width:900px){ .cover{height:240px;} }
    .body{padding:10px;}
    .ctitle{
      font-size:14px;font-weight:900;line-height:1.2;margin-bottom:8px;
      white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .openbtn{
      width:100%;padding:10px 12px;border-radius:10px;border:1px solid #2a2b35;
      background:var(--panel2);color:var(--text);cursor:pointer;font-weight:800;
    }
    .openbtn:hover{border-color:var(--accent);}

    .favBtn{
      position:absolute;top:10px;right:10px;
      width:36px;height:36px;border-radius:12px;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.12);
      display:flex;align-items:center;justify-content:center;
      cursor:pointer;user-select:none;
      backdrop-filter: blur(6px);
    }
    .favBtn.on{border-color: rgba(225,29,72,.9);}
    .favBtn span{font-size:18px;line-height:1;}

    .loading, .empty{
      margin-top:10px;padding:14px;background:var(--panel);
      border:1px solid #2a2b35;border-radius:12px;color:var(--muted);
      text-align:center;
    }
    .empty{display:none;}

    .bottomnav{
      position:fixed;left:0;right:0;bottom:0;z-index:60;height:var(--navh);
      background:#0b0c10;border-top:1px solid #222;
      display:flex;justify-content:space-around;align-items:center;padding:6px;
    }
    .navitem{width:25%;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);font-size:11px;user-select:none;cursor:pointer;}
    .navdot{width:30px;height:30px;border-radius:10px;background:var(--panel);border:1px solid #2a2b35;display:flex;align-items:center;justify-content:center;font-size:14px;}
    .active{color:var(--accent);}
    .active .navdot{border-color:var(--accent);}
  </style>
</head>

<body>
  <div class="topbar">
    <div class="iconbtn" id="backBtn" title="Back">‚Üê</div>
    <div class="brand" id="title">Author</div>
    <div class="spacer"></div>
    <div class="iconbtn" onclick="location.href='profile.html'" title="Profile">üë§</div>
  </div>

  <div class="section">
    <div id="authorCard" class="card" style="display:none;">
      <div class="headerRow">
        <div class="avatar" id="avatar">A</div>
        <div>
          <div class="name" id="name">Author</div>
          <div class="sub" id="sub">AUTHOR</div>
        </div>
      </div>
      <div class="pillRow" id="pills"></div>
    </div>

    <div id="loading" class="loading">Loading author‚Ä¶</div>
    <div id="empty" class="empty">No comics found.</div>
    <div id="grid" class="grid"></div>
  </div>

  <div class="bottomnav">
    <div class="navitem" onclick="location.href='index.html'">
      <div class="navdot">üè†</div><div>Home</div>
    </div>
    <div class="navitem active" onclick="location.href='authors.html'">
      <div class="navdot">‚úèÔ∏è</div><div>Authors</div>
    </div>
    <div class="navitem" onclick="location.href='request.html'">
      <div class="navdot">‚ûï</div><div>Request</div>
    </div>
    <div class="navitem" onclick="location.href='profile.html'">
      <div class="navdot">üë§</div><div>Me</div>
    </div>
  </div>

  <script>
    // author.html
const API = "https://api.34vault.com";


    const grid = document.getElementById("grid");
    const empty = document.getElementById("empty");
    const loading = document.getElementById("loading");

    const authorCard = document.getElementById("authorCard");
    const titleEl = document.getElementById("title");
    const avatarEl = document.getElementById("avatar");
    const nameEl = document.getElementById("name");
    const subEl = document.getElementById("sub");
    const pillsEl = document.getElementById("pills");

    document.getElementById("backBtn").addEventListener("click", () => {
      if (history.length > 1) history.back();
      else location.href = "authors.html";
    });

    const FAV_KEY = "favoriteSlugs";
    function getFavSet() {
      try {
        const arr = JSON.parse(localStorage.getItem(FAV_KEY) || "[]");
        return new Set(Array.isArray(arr) ? arr : []);
      } catch { return new Set(); }
    }
    function setFavSet(set) {
      localStorage.setItem(FAV_KEY, JSON.stringify(Array.from(set)));
    }

    function getId() {
      const sp = new URLSearchParams(location.search);
      return sp.get("id") || "";
    }

    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll("\"", "&quot;")
        .replaceAll("'", "&#039;");
    }

    function renderAuthor(author) {
      const dn = author.displayName || "Unknown";
      const role = String(author.role || "AUTHOR").toUpperCase();
      const num = author.userNumber != null ? `#${author.userNumber}` : "";

      document.title = `${dn} ‚Äî Author`;
      titleEl.textContent = dn;
      avatarEl.textContent = dn.trim().charAt(0).toUpperCase();
      nameEl.textContent = dn;
      subEl.textContent = `${role} ${num}`.trim();

      pillsEl.innerHTML = "";
      pillsEl.appendChild(makePill(role));
      if (author.isPlus) pillsEl.appendChild(makePill("PLUS", true));
      if (author.userNumber != null) pillsEl.appendChild(makePill(`#${author.userNumber}`));
      if (author.id) pillsEl.appendChild(makePill(`ID ${author.id}`));

      authorCard.style.display = "block";
    }

    function makePill(text, plus=false) {
      const d = document.createElement("div");
      d.className = "pill" + (plus ? " plus" : "");
      d.textContent = text;
      return d;
    }

    function renderComics(comics) {
      grid.innerHTML = "";
      const favs = getFavSet();

      empty.style.display = comics.length ? "none" : "block";
      if (!comics.length) return;

      for (const c of comics) {
        const slug = c.slug;
        const isFav = favs.has(slug);

        const card = document.createElement("div");
        card.className = "comic";
        card.innerHTML = `
          <a href="reader.html?slug=${encodeURIComponent(slug)}">
            <img class="cover"
                 src="${c.coverUrl || ""}"
                 alt="${escapeHtml(c.title || "Comic")}"
                 loading="lazy"
                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22600%22%3E%3Crect fill=%22%23333%22 width=%22400%22 height=%22600%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 fill=%22%23999%22 font-size=%2224%22%3ENo Image%3C/text%3E%3C/svg%3E'"/>
          </a>

          <div class="favBtn ${isFav ? "on" : ""}" title="Toggle favorite" data-slug="${escapeHtml(slug)}">
            <span>${isFav ? "‚≠ê" : "‚òÜ"}</span>
          </div>

          <div class="body">
            <div class="ctitle" title="${escapeHtml(c.title || "")}">${escapeHtml(c.title || "Untitled")}</div>
            <a href="reader.html?slug=${encodeURIComponent(slug)}">
              <button class="openbtn" type="button">Read</button>
            </a>
          </div>
        `;
        grid.appendChild(card);
      }

      grid.querySelectorAll(".favBtn").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          e.stopPropagation();
          const slug = btn.getAttribute("data-slug");
          const favs = getFavSet();
          if (favs.has(slug)) favs.delete(slug); else favs.add(slug);
          setFavSet(favs);
          // refresh only the star UI
          renderComics(comics);
        });
      });
    }

    async function load() {
      const id = getId();
      if (!id) {
        loading.style.display = "none";
        empty.style.display = "block";
        empty.textContent = "Missing ?id= in URL.";
        return;
      }

      try {
        loading.style.display = "block";
        empty.style.display = "none";

        // Backend doesn't provide /api/authors/:id, so we get authors list and find the one we need.
        const aRes = await fetch(`${API}/api/authors`);
        if (!aRes.ok) throw new Error("Failed to load authors");
        const authors = await aRes.json();
        const author = authors.find(x => String(x.id) === String(id));
        if (!author) throw new Error("Author not found");
        renderAuthor(author);

        const cRes = await fetch(`${API}/api/authors/${encodeURIComponent(id)}/comics`);
        if (!cRes.ok) throw new Error("Failed to load author comics");
        const comics = await cRes.json();

        loading.style.display = "none";
        renderComics(Array.isArray(comics) ? comics : []);
      } catch (e) {
        console.error(e);
        loading.style.display = "none";
        empty.style.display = "block";
        empty.textContent = "Failed to load author. Make sure backend is running and the author id is valid.";
      }
    }

    load();
  </script>
</body>
</html>
